#!/bin/bash
set -euo pipefail

APP_DIR="${TRIM_APPDEST}"
SERVER_DIR="${APP_DIR}/server"
FRONTEND_DIST="${APP_DIR}/frontend_dist"

LOG_FILE="${TRIM_PKGVAR}/info.log"
PID_FILE="${TRIM_PKGVAR}/app.pid"
ACCESSIBLE_PATHS_FILE="${TRIM_PKGVAR}/accessible_paths.txt"
VENV_DIR="${TRIM_PKGVAR}/.venv"
PORT="${TRIM_SERVICE_PORT:-18080}"

log_msg() {
    local msg
    msg="$(date '+%Y-%m-%d %H:%M:%S') - $1"
    echo "${msg}" | tee -a "${LOG_FILE}" >&2
    if [ -n "${TRIM_TEMP_LOGFILE:-}" ]; then
        echo "${msg}" >> "${TRIM_TEMP_LOGFILE}" 2>/dev/null || true
    fi
}

merge_accessible_paths() {
    local merged
    merged="${TRIM_DATA_ACCESSIBLE_PATHS:-}"
    if [ -n "${TRIM_DATA_SHARE_PATHS:-}" ]; then
        if [ -n "${merged}" ]; then
            merged="${merged}:${TRIM_DATA_SHARE_PATHS}"
        else
            merged="${TRIM_DATA_SHARE_PATHS}"
        fi
    fi
    printf '%s\n' "${merged}" > "${ACCESSIBLE_PATHS_FILE}"
}

first_share_path() {
    local raw
    raw="${TRIM_DATA_SHARE_PATHS:-}"
    if [ -z "${raw}" ]; then
        return 1
    fi
    IFS=':;,' read -r first _ <<< "${raw}"
    if [ -n "${first:-}" ]; then
        printf '%s\n' "${first}"
        return 0
    fi
    return 1
}

python_bin() {
    if [ -x "${VENV_DIR}/bin/python3" ]; then
        printf '%s\n' "${VENV_DIR}/bin/python3"
        return 0
    fi
    if [ -x "${VENV_DIR}/bin/python" ]; then
        printf '%s\n' "${VENV_DIR}/bin/python"
        return 0
    fi
    return 1
}

check_process() {
    local pid="$1"
    if [ -z "${pid}" ]; then
        return 1
    fi
    kill -0 "${pid}" 2>/dev/null
}

status_process() {
    if [ ! -r "${PID_FILE}" ]; then
        return 1
    fi
    local pid
    pid="$(head -n 1 "${PID_FILE}" | tr -d '[:space:]')"
    if check_process "${pid}"; then
        return 0
    fi
    rm -f "${PID_FILE}"
    return 1
}

start_process() {
    if status_process; then
        log_msg "Application already running."
        return 0
    fi

    mkdir -p "${TRIM_PKGVAR}" "${TRIM_PKGVAR}/config" "${TRIM_PKGVAR}/state" "${TRIM_PKGVAR}/downloads"
    merge_accessible_paths

    if [ ! -d "${SERVER_DIR}" ]; then
        log_msg "Server directory not found: ${SERVER_DIR}"
        return 1
    fi

    local pybin
    if ! pybin="$(python_bin)"; then
        log_msg "Python virtualenv not found. Please reinstall app or run install_init successfully."
        return 1
    fi

    local default_download_dir
    default_download_dir="${TRIM_PKGVAR}/downloads"
    if share_dir="$(first_share_path)"; then
        default_download_dir="${share_dir}"
    fi

    export APP_ENV=package
    export SETTINGS_FILE="${TRIM_PKGVAR}/config/settings.json"
    export STATE_DIR="${TRIM_PKGVAR}/state"
    export DOWNLOAD_PATH="${default_download_dir}"
    export FRONTEND_DIST
    export TRIM_DATA_ACCESSIBLE_PATHS_FILE="${ACCESSIBLE_PATHS_FILE}"
    export TRIM_DATA_ACCESSIBLE_PATHS="${TRIM_DATA_ACCESSIBLE_PATHS:-}"
    export TRIM_DATA_SHARE_PATHS="${TRIM_DATA_SHARE_PATHS:-}"

    log_msg "Starting F2 Web App on port ${PORT} ..."
    (
        cd "${SERVER_DIR}"
        "${pybin}" -m uvicorn app.main:app --host 0.0.0.0 --port "${PORT}" >> "${LOG_FILE}" 2>&1
    ) &

    local pid="$!"
    printf '%s' "${pid}" > "${PID_FILE}"
    sleep 1

    if check_process "${pid}"; then
        log_msg "Started with pid=${pid}"
        return 0
    fi

    log_msg "Start failed. Please check ${LOG_FILE}."
    rm -f "${PID_FILE}"
    return 1
}

stop_process() {
    if [ ! -r "${PID_FILE}" ]; then
        log_msg "Application not running."
        return 0
    fi

    local pid
    pid="$(head -n 1 "${PID_FILE}" | tr -d '[:space:]')"
    if ! check_process "${pid}"; then
        rm -f "${PID_FILE}"
        log_msg "Stale pid file removed."
        return 0
    fi

    log_msg "Stopping pid=${pid} ..."
    kill -TERM "${pid}" 2>/dev/null || true

    local count=0
    while check_process "${pid}" && [ "${count}" -lt 10 ]; do
        sleep 1
        count=$((count + 1))
    done

    if check_process "${pid}"; then
        log_msg "Force killing pid=${pid} ..."
        kill -KILL "${pid}" 2>/dev/null || true
    fi

    rm -f "${PID_FILE}"
    log_msg "Stopped."
}

case "${1:-}" in
start)
    start_process
    ;;
stop)
    stop_process
    ;;
status)
    if status_process; then
        exit 0
    fi
    exit 3
    ;;
*)
    echo "Usage: $0 {start|stop|status}" >&2
    exit 1
    ;;
esac
